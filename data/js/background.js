// Generated by CoffeeScript 1.3.3
(function() {
  var getActiveWindow, install, onExtRequest, onTabCreated, onTabRemoved, onTabUpdated, root, shareLink, sharePage, shareSelection, shareWithTwuner, showTwunerTab, tabChangedHandler, uninstall;

  tabChangedHandler = function(tab) {
    if (tab.url.indexOf(chrome.extension.getURL("index.html")) !== -1) {
      if (root._twunerTab) {
        if (tab.id !== root._twunerTab.id) {
          showTwunerTab();
        }
      } else {
        root._twunerTab = tab;
      }
    }
  };

  sharePage = function(info, tab) {
    shareWithTwuner(tab.title + ' ' + info.pageUrl);
  };

  shareSelection = function(info, tab) {
    shareWithTwuner("\"" + info.selectionText + "\" via: " + info.pageUrl);
  };

  shareLink = function(info, tab) {
    shareWithTwuner(info.linkUrl);
  };

  getActiveWindow = function() {
    var v, views, _i, _len;
    views = chrome.extension.getViews();
    for (_i = 0, _len = views.length; _i < _len; _i++) {
      v = views[_i];
      if (v.location.href === root._twunerTab.url) {
        return v;
      }
    }
    return null;
  };

  showTwunerTab = function() {
    var proc;
    if (root._twunerTab) {
      proc = function(c) {
        var _ref;
                if ((_ref = c.focused) != null) {
          _ref;

        } else {
          chrome.windows.update(c.id, {
            focused: true
          });
        };
      };
      chrome.tabs.get(root._twunerTab.id, function(c) {
        root._twunerTab = c;
        return chrome.windows.get(c.windowId, proc);
      });
      chrome.tabs.update(root._twunerTab.id, {
        selected: true
      });
    }
  };

  shareWithTwuner = function(str) {
    var _doShare;
    _doShare = function() {
      var win, _testProc;
      win = getActiveWindow();
      _testProc = function() {
        if (win && win.globals) {
          if (win.globals.signed_in) {
            win.ui.StatusBox.change_mode(win.ui.StatusBox.MODE_TWEET);
            win.ui.StatusBox.set_status_text(str);
            return win.ui.StatusBox.open();
          } else {
            try {
              return win.toast.set('You must sign in to share content.').show(-1);
            } catch (e) {
              return setTimeout(_testProc, 1000);
            }
          }
        } else {
          return setTimeout(_testProc, 500);
        }
      };
      return _testProc();
    };
    if (root._twunerTab && root._twunerTab.id) {
      showTwunerTab();
      _doShare();
    } else {
      chrome.tabs.create({
        url: "index.html"
      }, function() {
        return setTimeout(_doShare, 500);
      });
    }
  };

  onTabCreated = function(tab) {
    tabChangedHandler(tab);
  };

  onTabUpdated = function(id, info, tab) {
    tabChangedHandler(tab);
  };

  onTabRemoved = function(id, info) {
    if (root._twunerTab) {
      if (root._twunerTab.id === id) {
        root._twunerTab = null;
      }
    }
  };

  onExtRequest = function(req, sender, response) {
    if (req.enableContextMenu) {
      install();
      response({
        'reply': 'getcha, context menu has been enabled.'
      });
    } else {
      uninstall();
      response({
        'reply': 'getcha, context menu has been disabled.'
      });
    }
  };

  install = function() {
    var contexts;
    contexts = ["page", "selection", "link"];
    if (root._menuItemSharePageId === null) {
      root._menuItemSharePageId = chrome.contextMenus.create({
        "title": "Share Page with Twuner",
        "contexts": ["page"],
        "onclick": sharePage
      });
    }
    if (root._menuItemShareSelId === null) {
      root._menuItemShareSelId = chrome.contextMenus.create({
        "title": "Share Selection with Twuner",
        "contexts": ["selection"],
        "onclick": shareSelection
      });
    }
    if (root._menuItemShareLinkId === null) {
      root._menuItemShareLinkId = chrome.contextMenus.create({
        "title": "Share Link with Twuner",
        "contexts": ["link"],
        "onclick": shareLink
      });
    }
  };

  uninstall = function() {
    chrome.contextMenus.removeAll();
    root._menuItemSharePageId = null;
    root._menuItemShareSelId = null;
    root._menuItemShareLinkId = null;
    if (chrome.tabs.onCreated.hasListener(onTabCreated)) {
      chrome.tabs.onCreated.removeListener(onTabCreated);
    }
    if (chrome.tabs.onUpdated.hasListener(onTabUpdated)) {
      chrome.tabs.onUpdated.removeListener(onTabUpdated);
    }
  };

  chrome.tabs.onCreated.addListener(onTabCreated);

  chrome.tabs.onUpdated.addListener(onTabUpdated);

  chrome.tabs.onRemoved.addListener(onTabRemoved);

  chrome.extension.onRequest.addListener(onExtRequest);

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root._twunerTab = null;

  root._install = install;

  root._uninstall = uninstall;

  root._menuItemSharePageId = null;

  root._menuItemShareSelId = null;

  root._menuItemShareLinkId = null;

}).call(this);
